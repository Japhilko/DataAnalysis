<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: BKGWebMap/Control/Geocoder.js</title>
    
    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="content">
    <nav>
        <h2><a href="index.html">Index</a></h2><h3>Namespaces</h3><ul><li><a href="BKGWebMap.html">BKGWebMap</a></li><li><a href="BKGWebMap.Control.html">BKGWebMap.Control</a></li><li><a href="BKGWebMap.Layer.html">BKGWebMap.Layer</a></li><li><a href="BKGWebMap.Layer.DGM.html">BKGWebMap.Layer.DGM</a></li><li><a href="BKGWebMap.Layer.DLM.html">BKGWebMap.Layer.DLM</a></li><li><a href="BKGWebMap.Layer.DOP.html">BKGWebMap.Layer.DOP</a></li><li><a href="BKGWebMap.Layer.DTK.html">BKGWebMap.Layer.DTK</a></li><li><a href="BKGWebMap.Layer.TopPlus.html">BKGWebMap.Layer.TopPlus</a></li><li><a href="BKGWebMap.Layer.VG.html">BKGWebMap.Layer.VG</a></li><li><a href="BKGWebMap.Layer.WebAtlasDE.html">BKGWebMap.Layer.WebAtlasDE</a></li><li><a href="BKGWebMap.Protocol.html">BKGWebMap.Protocol</a></li><li><a href="BKGWebMap.Util.html">BKGWebMap.Util</a></li></ul><h3>Classes</h3><ul><li><a title="BKGWebMap.Control.CookieCheck" href="BKGWebMap.Control.CookieCheck.html">CookieCheck</a></li><li><a title="BKGWebMap.Control.Geocoder" href="BKGWebMap.Control.Geocoder.html">Geocoder</a></li><li><a title="BKGWebMap.Control.Geocoder.LayerView" href="BKGWebMap.Control.Geocoder.LayerView.html">LayerView</a></li><li><a title="BKGWebMap.Control.Geocoder.ListView" href="BKGWebMap.Control.Geocoder.ListView.html">ListView</a></li><li><a title="BKGWebMap.Control.Geocoder.View" href="BKGWebMap.Control.Geocoder.View.html">View</a></li><li><a title="BKGWebMap.Control.LayerSwitcher" href="BKGWebMap.Control.LayerSwitcher.html">LayerSwitcher</a></li><li><a title="BKGWebMap.Control.LayerSwitcher.AdvancedLayerEntry" href="BKGWebMap.Control.LayerSwitcher.AdvancedLayerEntry.html">AdvancedLayerEntry</a></li><li><a title="BKGWebMap.Control.LayerSwitcher.BuzzyIndicator" href="BKGWebMap.Control.LayerSwitcher.BuzzyIndicator.html">BuzzyIndicator</a></li><li><a title="BKGWebMap.Control.LayerSwitcher.Component" href="BKGWebMap.Control.LayerSwitcher.Component.html">Component</a></li><li><a title="BKGWebMap.Control.LayerSwitcher.LayerEntry" href="BKGWebMap.Control.LayerSwitcher.LayerEntry.html">LayerEntry</a></li><li><a title="BKGWebMap.Control.Legend" href="BKGWebMap.Control.Legend.html">Legend</a></li><li><a title="BKGWebMap.Control.Link" href="BKGWebMap.Control.Link.html">Link</a></li><li><a title="BKGWebMap.Control.Measurement" href="BKGWebMap.Control.Measurement.html">Measurement</a></li><li><a title="BKGWebMap.Control.NavToolbar" href="BKGWebMap.Control.NavToolbar.html">NavToolbar</a></li><li><a title="BKGWebMap.Control.OverViewMap" href="BKGWebMap.Control.OverViewMap.html">OverViewMap</a></li><li><a title="BKGWebMap.Control.Permalink" href="BKGWebMap.Control.Permalink.html">Permalink</a></li><li><a title="BKGWebMap.Control.Search" href="BKGWebMap.Control.Search.html">Search</a></li><li><a title="BKGWebMap.Control.SidePanel" href="BKGWebMap.Control.SidePanel.html">SidePanel</a></li><li><a title="BKGWebMap.Control.Window" href="BKGWebMap.Control.Window.html">Window</a></li><li><a title="BKGWebMap.Control.WMSGetFeatureInfo" href="BKGWebMap.Control.WMSGetFeatureInfo.html">WMSGetFeatureInfo</a></li><li><a title="BKGWebMap.Control.WMSGetFeatureInfo.GeoJSONTextTransformer" href="BKGWebMap.Control.WMSGetFeatureInfo.GeoJSONTextTransformer.html">GeoJSONTextTransformer</a></li><li><a title="BKGWebMap.Control.WMSGetFeatureInfo.TextTransformer" href="BKGWebMap.Control.WMSGetFeatureInfo.TextTransformer.html">TextTransformer</a></li><li><a title="BKGWebMap.Control.ZoomLevel" href="BKGWebMap.Control.ZoomLevel.html">ZoomLevel</a></li><li><a title="BKGWebMap.Layer.MarkerLayer" href="BKGWebMap.Layer.MarkerLayer.html">MarkerLayer</a></li><li><a title="BKGWebMap.Layer.WMS" href="BKGWebMap.Layer.WMS.html">WMS</a></li><li><a title="BKGWebMap.MapBuilder" href="BKGWebMap.MapBuilder.html">MapBuilder</a></li><li><a title="BKGWebMap.Popup" href="BKGWebMap.Popup.html">Popup</a></li><li><a title="BKGWebMap.Protocol.Geoindex" href="BKGWebMap.Protocol.Geoindex.html">Geoindex</a></li><li><a title="BKGWebMap.Util.AutoSuggest" href="BKGWebMap.Util.AutoSuggest.html">AutoSuggest</a></li><li><a title="BKGWebMap.Util.Slider" href="BKGWebMap.Util.Slider.html">Slider</a></li><li><a title="BKGWebMap.Util.Toggler" href="BKGWebMap.Util.Toggler.html">Toggler</a></li></ul><h3>Global</h3><ul><li><a href="global.html#VERSION_NUMBER">VERSION_NUMBER</a></li></ul>
    </nav>

    <div id="main">
        <h1 class="page-title">Source: BKGWebMap/Control/Geocoder.js</h1>

        


    
    <section>
        <article>
            <pre class="prettyprint source"><code>/*
 * Copyright (c) 2013 Bundesamt by Kartographie und Geodäsie.
 * See license.txt in the BKG WebMap distribution or repository for the
 * full text of the license.
 *
 * Author: Dirk Thalheim
 */

/**
 * @requires OpenLayers/BaseTypes/Class.js
 * @requires OpenLayers/BaseTypes/Element.js
 * @requires BKGWebMap/Util.js
 * @requires BKGWebMap/Control/Search.js
 * @requires BKGWebMap/Protocol/Geoindex.js
 * @requires BKGWebMap/Util/AutoSuggest.js
 */


/**
 *
 * Zusätzliche Events:
 * &lt;ul>
 *     &lt;li>error - Bei Fehlern in Geocodierung; zusätzliche Event-Property response&lt;/li>
 *     &lt;li>locationupdate - Nach erfolgreicher Geocodierung; zusätzliche Event-Property response&lt;/li>
 *     &lt;li>hoverfeature - Hervorheben eines Features&lt;/li>
 * &lt;/ul>
 * @classdesc Kontrollelement für Geocodierung
 *
 * @constructor BKGWebMap.Control.Geocoder
 * @param {object} options - Optionen für das Controlelement
 **/
BKGWebMap.Control.Geocoder = OpenLayers.Class(BKGWebMap.Control.Search, {

    /**
     * URL für Geocodierungsdienst
     * @memberOf BKGWebMap.Control.Geocoder
     * @type string
     */
    url: 'http://sg.geodatenzentrum.de/gdz_geoindex',

    /**
     * Protokoll für Interaktion mit Geocodierungsdienst
     * @memberOf BKGWebMap.Control.Geocoder
     * @type BKGWebMap.Protocol.Geoindex
     */
    protocol: null,

    /**
     * Speichert die aktuelle Anfrage.
     * @memberOf BKGWebMap.Control.Geocoder
     * @type BKGWebMap.Protocol.Geoindex.Response
     */
    response: null,

    /**
     * Beschränkung der Suche auf aktuellen Kartenausschnitt.
     * @memberOf BKGWebMap.Control.Geocoder
     * @type boolean
     */
    useMapExtend: false,

    /**
     * Liste an Views für die Ergebnisdarstellung.
     * @memberOf BKGWebMap.Control.Geocoder
     * @type Array
     */
    views: [],

    initialize: function(options) {
        options = options || {};
        options.url = options.url || this.url;
        options.protocol = options.protocol || new BKGWebMap.Protocol.Geoindex({url: options.url});

        BKGWebMap.Control.Search.prototype.initialize.apply(this, [options]);

        BKGWebMap.Util.each(
                this.views,
                OpenLayers.Function.bind( function(index, view) { this.registerViewEvents(view); }, this )
        );

    },

    setMap: function(map) {
        BKGWebMap.Control.Search.prototype.setMap.apply(this, arguments);

        // Projektion für Ortssuche setzen
        this.protocol.srsName = map.projection;

        // map den Views übergeben
        BKGWebMap.Util.each( this.views, OpenLayers.Function.bind(function(index, view) { view.setMap(this); }, map) );

        // Über Änderungen des Viewports informiert werden:
        this.updateViewPort();
        map.events.on({
            moveend: this.updateViewPort,
            scope: this
        });

    },

    draw: function(px) {
        var div = BKGWebMap.Control.Search.prototype.draw.apply(this);
        // Autocomplete-Funktionalität initialisieren
        if(this.protocol.canAutocomplete) {
            this.autocomplete = new BKGWebMap.Util.AutoSuggest(this.input, this.protocol, {events: this.inputEvents});
        }
        return div;
    },

    /**
     * Fügt eine View für die Ergebnisdarstellung dem Geocoder hinzu.
     * @memberOf BKGWebMap.Control.Geocoder
     * @param {BKGWebMap.Control.Geocoder.View} view - Die View für die ergebnisanzeige
     */
    addView: function(view) {
        this.views.push(view);
        this.registerViewEvents(view);
        if(this.map) view.setMap(this.map);
    },

    registerViewEvents: function(view) {
        view.setGeocoder(this);
        this.events.on({
            "startsearch": view.onStartSearch,
            "error": view.onError,
            "locationupdate": view.onLocationUpdate,
            "hoverfeature": view.onHoverFeature,
            scope: view
        });
    },

    /**
     * Startet die Geocodierung
     *
     * @memberOf BKGWebMap.Control.Geocoder
     */
    triggerSearch: function() {
        BKGWebMap.Control.Search.prototype.triggerSearch.apply(this);
        if(this.response) {
            this.protocol.abort(this.response);
            this.response = null;
        }
        OpenLayers.Element.addClass(this.searchButton, "active");

        // stoppe AutoSuggest
        if(this.autocomplete) {
          this.autocomplete.hideSuggestions();  // hide the suggestion when searching
          this.autocomplete.cancel();
        }

        this.response = this.protocol.geocode(this.getValue(), {callback: this.handleResult, scope: this});
    },

    /**
     * Verarbeitet die Antwort vom Geocodierungsdienst
     * @memberOf BKGWebMap.Control.Geocoder
     * @param {BKGWebMap.Protocol.Geoindex.Response} response
     */
    handleResult: function(response) {
        OpenLayers.Element.removeClass(this.searchButton, "active");
        this.response = null;

        if(response.code != BKGWebMap.Protocol.Geoindex.Response.SUCCESS) {
            this.events.triggerEvent("error", {response: response});
            return;
        }

        switch(response.requestType) {
            case 'geocode':
                this.events.triggerEvent("locationupdate", {response: response});
                break;
        }
    },

    hoverFeature: function(feature, hover) {
        this.events.triggerEvent("hoverfeature", {feature: feature, hover: hover});
    },

    /**
     * Wird vom moveend-Event der Karte getriggert und informiert über Änderung des Viewports
     * @memberOf BKGWebMap.Control.Geocoder
     */
    updateViewPort: function() {
        if(!this.useMapExtend) return;
        // Kartenausdehnung im Protokoll verwenden
        this.protocol.bounds = this.map.getExtent();
        // Suggest-Cache leeren
        this.protocol.clearCache();
        // Autosuggest zurücksetzen
        if(this.autocomplete) {
            this.autocomplete.clearSuggestions();
        }
    },

    CLASS_NAME: "BKGWebMap.Control.Geocoder"
});

/**
 * Factory-Funktion zur Generierung eines Geocoder Steuerelement. Standardmäßig wird dieser mit einem LayerView
 * generiert. Falls ein BKGWebMap.Control.SidePanel in der controls-Liste enthalten ist, wird zusätzlich ein
 * BKGWebMap.Control.Geocoder.ListView dem Geocoder hinzugefügt.
 *
 * @param {Array&lt;OpenLayers.Control>} controls - Liste der Steuerelemente, in die die neue erzeugten Steuerelemente
 *                                               eingefügt werden sollen.
 * @param {object} config - Konfiguration für Steuerelement (s. Konstruktor BKGWebMap.Control.Geocoder).
 */
BKGWebMap.Control.FACTORIES['geocoder'] = function(controls, config) {
    if (!config) return;

    var geocoder = new BKGWebMap.Control.Geocoder(config);
    geocoder.addView(new BKGWebMap.Control.Geocoder.LayerView());

    var sidePanel = BKGWebMap.Util.grep(controls, function(c) {return c.CLASS_NAME === 'BKGWebMap.Control.SidePanel'});
    if (sidePanel.length > 0) {
        var resultsDiv = document.createElement('div');

        var resultsDivTitle = document.createElement('h3');
        resultsDivTitle.innerHTML = 'Suchergebnisse';

        sidePanel[0].content.appendChild(resultsDivTitle );
        OpenLayers.Element.addClass(resultsDiv, 'geocoderResults');
        sidePanel[0].content.appendChild(resultsDiv);
        geocoder.addView(new BKGWebMap.Control.Geocoder.ListView({div: resultsDiv}));
    }
    controls.push(geocoder);
};
</code></pre>
        </article>
    </section>




    </div>

    <br clear="both">

    <footer>
        Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.0-dev</a> on Fri Feb 06 2015 14:23:23 GMT+0100 (MEZ)
    </footer>
</div>

<script> prettyPrint(); </script>
</body>
</html>
